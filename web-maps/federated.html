<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federated STA Data</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
     <link rel="stylesheet" href="L.Control.ZoomBox.css"/>   
     <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>
    <style>
        .map {
            height: 800px;
            width: 50%;
            margin: 0 auto;
            display: block;
            border: 3px solid #444; /* Add frame */
            border-radius: 12px;    /* Optional: rounded corners */
            box-shadow: 0 4px 16px rgba(0,0,0,0.2); /* Optional: shadow */
        }
    </style>
    <script src="L.Control.ZoomBox.min.js"></script>
    <script src="https://unpkg.com/sta-map"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>

<body>
    <h1>Federated STA Data - Leaflet Map Example</h1>
    <br>
    <p>A Leaflet map Based on https://github.com/DataCoveEU/STAM connected to a number of SensorThings API endpoints,
        including:
		<ul>
            <li><a href="https://linkedsystems.uk/sensorthings/v1.1" target="_blank">https://linkedsystems.uk/sensorthings/v1.1</a></li>
            <li><a href="https://sensors.bgs.ac.uk/FROST-Server/v1.1" target="_blank">https://sensors.bgs.ac.uk/FROST-Server/v1.1</a></li>
        </ul>
	</p>
    <br>
    <p>SensorThings API is a international standard developed by the OGC (https://www.ogc.org/standards/sensorthings)
        using RESTful OData interface. Users can connect to the API using Python, Jupyter Notebooks, QGIS, ESRI and other
        clients</p>
    <br>
    <div id="map" class="map"></div>
    <script>
        var map2 = L.map('map', {
            preferCanvas: true
        }).setView([40, -35], 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map2);

        // Add location search control
        L.Control.geocoder({
            defaultMarkGeocode: true
        }).addTo(map2);

        // // Create separate Sta-map layers for each base URL
        // var staMap1 = L.stam({
        //     baseUrl: "https://sensors.bgs.ac.uk/FROST-Server/v1.1",
        //     markerStyle: function (feature) {
        //         return "green";
        //     },
        //     cluster: false,
        //     queryObject: [{
        //         zoomLevel: {
        //             from: 0,
        //             to: 18
        //         },
        //         query: {
        //             entityType: 'Things',
        //             filter: "length(Locations/name) gt 4",
        //         }
        //     }]
        // });

        // var staMap2 = L.stam({
        //     baseUrl: "https://linkedsystems.uk/sensorthings/v1.1",
        //     markerStyle: function (feature) {
        //         return "orange";
        //     },
        //     cluster: false,
        //     queryObject: [{
        //         zoomLevel: {
        //             from: 0,
        //             to: 18
        //         },
        //         query: {
        //             entityType: 'Things',
        //             filter: "length(Locations/name) gt 4",
        //         }
        //     }]
        // });

        // // Add the Sta-map layers to the map
        // map2.addLayer(staMap1);
        // map2.addLayer(staMap2);

        // Create two cluster groups with custom cluster icons
        var bgsCluster = L.markerClusterGroup({
            maxClusterRadius: 10,
            iconCreateFunction: function(cluster) {
                return L.divIcon({
                    html: `<div style="background:green;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;">${cluster.getChildCount()}</div>`,
                    className: 'bgs-cluster-icon',
                    iconSize: [32, 32]
                });
            }
        });

        var linkedCluster = L.markerClusterGroup({
            maxClusterRadius: 10,
            iconCreateFunction: function(cluster) {
                return L.divIcon({
                    html: `<div style="background:orange;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;">${cluster.getChildCount()}</div>`,
                    className: 'linked-cluster-icon',
                    iconSize: [32, 32]
                });
            }
        });

        function addSensorThingsMarkers(apiUrl, color, clusterGroup) {
            const url = apiUrl + "/Things?$expand=Locations,Datastreams($expand=ObservedProperty)&$filter=length(Locations/name) gt 4";
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data.value) return;
                    data.value.forEach(thing => {
                        if (thing.Locations && thing.Locations.length > 0) {
                            thing.Locations.forEach(loc => {
                                if (loc.location && loc.location.coordinates) {
                                    var coords = loc.location.coordinates;
                                    let popupContent = `<b>${thing.name}</b><br>${loc.name || ""}<br><ul>`;
                                    if (thing.Datastreams && thing.Datastreams.length > 0) {
                                        thing.Datastreams.forEach(ds => {
                                            if (ds.ObservedProperty) {
                                                popupContent += `<li style="cursor:pointer;color:blue;text-decoration:underline;" onclick="showPlotlyChart('${apiUrl}',${ds['@iot.id']},'${ds.ObservedProperty.name.replace(/'/g,"")}')">${ds.ObservedProperty.name}</li>`;
                                            }
                                        });
                                    }
                                    popupContent += "</ul>";
                                    var marker = L.marker([coords[1], coords[0]], {
                                        icon: color === "green" ? L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]}) : 
                                            L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]})
                                    }).bindPopup(popupContent);
                                    clusterGroup.addLayer(marker);
                                }
                            });
                        }
                    });
                });
        }

        // Add markers for both APIs, each to its own cluster group
        addSensorThingsMarkers("https://sensors.bgs.ac.uk/FROST-Server/v1.1", "green", bgsCluster);
        addSensorThingsMarkers("https://linkedsystems.uk/sensorthings/v1.1", "orange", linkedCluster);

        // Add both cluster groups to the map
        map2.addLayer(bgsCluster);
        map2.addLayer(linkedCluster);


        // Add this function to your script for Plotly modal
        function showPlotlyChart(apiUrl, datastreamId, observedProperty) {
            // Create modal container if not exists
            let modal = document.getElementById('plotly-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'plotly-modal';
                modal.style.position = 'fixed';
                modal.style.top = '10%';
                modal.style.left = '50%';
                modal.style.transform = 'translateX(-50%)';
                modal.style.background = '#fff';
                modal.style.border = '2px solid #444';
                modal.style.borderRadius = '8px';
                modal.style.zIndex = 9999;
                modal.style.padding = '20px';
                modal.innerHTML = '<button onclick="document.getElementById(\'plotly-modal\').remove()">Close</button><div id="plotly-chart" style="width:600px;height:400px;"></div>';
                document.body.appendChild(modal);
            }
            // Fetch Observations
            fetch(`${apiUrl}/Datastreams(${datastreamId})/Observations?$top=100&$orderby=phenomenonTime asc`)
                .then(response => response.json())
                .then(data => {
                    const x = [];
                    const y = [];
                    data.value.forEach(obs => {
                        x.push(obs.phenomenonTime);
                        y.push(obs.result);
                    });
                    Plotly.newPlot('plotly-chart', [{
                        x: x,
                        y: y,
                        type: 'scatter',
                        name: observedProperty
                    }], {
                        title: `Plot for ${observedProperty}`,
                        xaxis: { title: 'Time' },
                        yaxis: { title: 'Value' }
                    }, {responsive: true});
                });
        }

        // Using a custom SVG icon as content
        var control = L.control.zoomBox({ addToZoomControl: true, modal: true });
        map2.addControl(control); 

        // Add legend control
        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML += '<h4>Legend</h4>';
            div.innerHTML += '<i style="background:green;width:12px;height:12px;display:inline-block;margin-right:5px;"></i> BGS Sensors<br>';
            div.innerHTML += '<i style="background:orange;width:12px;height:12px;display:inline-block;margin-right:5px;"></i> LinkedSystems Sensors<br>';
            return div;
        };

        legend.addTo(map2);
    </script>
    <br>
    <p>Source Data: 
        <br>https://linkedsystems.uk/sensorthings/v1.1 
        <br>https://sensors.bgs.ac.uk/FROST-Server/v1.1
    </p>
    <br>
</body>

</html>
